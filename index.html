<!DOCTYPE html>
<html>
<head>
<title>Elora</title>

<style>
body{
font-family:Arial, sans-serif;
background:linear-gradient(135deg,#5f3dc4,#7c5cff);
margin:0;
padding:20px;
min-height:100vh;
display:flex;
align-items:center;
justify-content:center;
}

.card{
background:white;
width:100%;
max-width:500px;
padding:40px;
border-radius:20px;
box-shadow:0 8px 32px rgba(0,0,0,0.1);
}

h2, h3{
margin-top:0;
color:#2d3748;
font-weight:600;
}

h3{
font-size:28px;
margin-bottom:30px;
}

h4{
margin-top:30px;
margin-bottom:15px;
color:#2d3748;
font-weight:600;
font-size:18px;
}

label{
display:block;
margin-bottom:8px;
color:#4a5568;
font-weight:500;
font-size:14px;
}

input[type="text"],
input[type="email"],
input[type="password"],
input[type="number"],
select{
width:100%;
padding:12px 16px;
margin-bottom:20px;
border:2px solid #e2e8f0;
border-radius:8px;
font-size:15px;
box-sizing:border-box;
transition:border-color 0.3s;
}

input:focus,
select:focus{
outline:none;
border-color:#7c5cff;
}

.checkbox-label{
display:flex;
align-items:center;
margin-bottom:20px;
font-size:14px;
color:#4a5568;
}

.checkbox-label input[type="checkbox"]{
width:auto;
margin-right:8px;
margin-bottom:0;
}

.btn{
width:100%;
padding:14px;
margin-bottom:12px;
border:none;
border-radius:8px;
cursor:pointer;
font-size:16px;
font-weight:600;
transition:all 0.3s;
}

.btn:hover{
transform:translateY(-2px);
box-shadow:0 4px 12px rgba(0,0,0,0.15);
}

.primary{
background:#ff6b6b;
color:white;
}

.primary:hover{
background:#ff5252;
}

.white{
background:#f7fafc;
color:#2d3748;
border:2px solid #e2e8f0;
}

.white:hover{
background:#edf2f7;
}

.back{
background:#2d3748;
color:white;
}

.back:hover{
background:#1a202c;
}

.hidden{
display:none;
}

#menuList p, #waiterList p{
padding:12px;
background:#f7fafc;
border-radius:8px;
margin-bottom:8px;
display:flex;
justify-content:space-between;
align-items:center;
}

#menuList button, #waiterList button{
background:#ff6b6b;
color:white;
border:none;
padding:6px 12px;
border-radius:6px;
cursor:pointer;
font-weight:600;
}

#menuList button:hover, #waiterList button:hover{
background:#ff5252;
}

#tableButtons .btn{
margin-bottom:10px;
}

#billingArea, #menuArea{
margin-top:20px;
}

#billOutput{
background:#f7fafc;
padding:20px;
border-radius:8px;
margin-bottom:20px;
line-height:1.8;
}

#billOutput hr{
border:none;
border-top:2px solid #e2e8f0;
margin:15px 0;
}

.personName{
width:100%;
padding:12px 16px;
margin-bottom:20px;
border:2px solid #e2e8f0;
border-radius:8px;
font-size:15px;
box-sizing:border-box;
transition:border-color 0.3s;
}

.personName:focus{
outline:none;
border-color:#7c5cff;
}

.row{
display:flex;
gap:15px;
}

.row .col{
flex:1;
}

.row .col label{
display:block;
margin-bottom:8px;
}

.row .col input{
width:100%;
margin-bottom:20px;
}
</style>
</head>

<body>

<!-- WELCOME -->
<div id="welcome" class="card">
<h2>Welcome to Elora</h2>
<button class="btn primary" onclick="show('managerLogin')">Manager</button>
<button class="btn white" onclick="show('waiterLogin')">Waiter</button>
</div>

<!-- MANAGER SIGNUP -->
<div id="managerSignup" class="card hidden">
<h3>Manager's Signup</h3>
<label>Email</label>
<input id="mEmail" type="email" placeholder="Email">
<label>Password</label>
<input id="mPass" type="password" placeholder="Password">
<label>Name</label>
<input id="mName" type="text" placeholder="Name">
<label class="checkbox-label">
<input type="checkbox" onclick="togglePass('mPass')"> Show Password
</label>
<button class="btn primary" onclick="signup()">Signup</button>
<button class="btn white" onclick="show('managerLogin')">Already have an account? Login</button>
<button class="btn back" onclick="show('welcome')">Back</button>
</div>

<!-- MANAGER LOGIN -->
<div id="managerLogin" class="card hidden">
<h3>Manager's Login</h3>
<label>Username</label>
<input id="lEmail" type="email" placeholder="Username">
<label>Password</label>
<input id="lPass" type="password" placeholder="Password">
<label>Name</label>
<input id="lName" type="text" placeholder="Name">
<label class="checkbox-label">
<input type="checkbox" onclick="togglePass('lPass')"> Show Password
</label>
<button class="btn primary" onclick="login()">Login</button>
<button class="btn white" onclick="show('managerSignup')">Signup</button>
<button class="btn back" onclick="show('welcome')">Back</button>
</div>

<!-- MANAGER DASH -->
<div id="managerDash" class="card hidden">
<h3>Restaurant Setup</h3>

<h4>Section 1 : Add Restaurant Name</h4>
<div class="row">
<div class="col">
<label>Restaurant Name</label>
<input id="restName" type="text" placeholder="Restaurant Name">
</div>
<div class="col">
<label>Number of Tables</label>
<input id="tables" type="number" placeholder="0">
</div>
</div>

<button class="btn primary" onclick="setupRestaurant()">Save Restaurant</button>

<h4>Section 2 : Add/Delete Waiter Name</h4>
<label>Waiter Name</label>
<input id="waiterName" type="text" placeholder="Waiter Name">
<button class="btn primary" onclick="addWaiter()">Add Waiter</button>

<div id="waiterList"></div>

<h4>Section 3 : Add/Delete Menu Items</h4>
<label>Item Name</label>
<input id="itemName" type="text" placeholder="Item Name">
<label>Price</label>
<input id="itemPrice" type="number" placeholder="Price">
<button class="btn primary" onclick="addMenu()">Add Item</button>

<div id="menuList"></div>

<button class="btn back" onclick="show('welcome')" style="margin-top:20px;">Logout</button>
</div>

<!-- WAITER LOGIN -->
<div id="waiterLogin" class="card hidden">
<h3>Waiter Access</h3>
<label>Restaurant Code</label>
<input id="codeInput" type="text" placeholder="Enter Restaurant Code">
<button class="btn primary" onclick="waiterEnter()">Enter</button>
<button class="btn back" onclick="show('welcome')">Back</button>
</div>

<!-- TABLES -->
<div id="tablesScreen" class="card hidden">
<h3>Select Table</h3>
<div id="tableButtons"></div>
<button class="btn back" onclick="show('waiterLogin')">Back</button>
</div>

<!-- ORDER -->
<div id="orderScreen" class="card hidden">
<h3>Take Order</h3>

<label>Group Type</label>
<select id="groupType">
<option>Family</option>
<option>Friends</option>
<option>Other</option>
</select>

<button class="btn primary" onclick="continueBilling()">Continue to Menu</button>

<div id="billingArea"></div>
<div id="menuArea"></div>

<button class="btn back" onclick="show('tablesScreen')">Back to Tables</button>
</div>

<!-- FINAL BILL -->
<div id="billScreen" class="card hidden">
<h3>Final Bill</h3>
<div id="billOutput"></div>
<button class="btn primary" onclick="printBill()">Print Bill</button>
<button class="btn back" onclick="show('tablesScreen')">Done</button>
</div>

<script>

// GOOGLE SHEETS CONFIGURATION
const SHEETS_URL = 'https://script.google.com/macros/s/AKfycbwgLsg-OsKJZ6yrmIEJIpUDFVrX8OxjgqK1JNtUNfLFHcGmMtB-q9xAyia889_zY9LcLA/exec';
let currentManagerEmail = '';
let currentManagerName = '';
let currentRestaurantCode = '';

async function sendToSheets(action, data) {
  try {
    const response = await fetch(SHEETS_URL, {
      method: 'POST',
      body: JSON.stringify({action: action, ...data})
    });
    return await response.json();
  } catch(e) {
    console.error('Sheets error:', e);
    return {status: 'error'};
  }
}

function show(id){
document.querySelectorAll(".card").forEach(c=>c.classList.add("hidden"));
document.getElementById(id).classList.remove("hidden");
}

function togglePass(id){
let f=document.getElementById(id);
f.type=f.type==="password"?"text":"password";
}

async function signup(){
  const email = mEmail.value;
  const pass = mPass.value;
  const name = mName.value;
  
  if(!email || !pass || !name){
    alert("Please fill all fields");
    return;
  }
  
  // Save to Google Sheets
  await sendToSheets('saveManager', {email: email, pass: pass, name: name});
  
  // Also save to localStorage as backup
  localStorage.setItem("manager",JSON.stringify({email: email, pass: pass, name: name}));
  
  alert("Signup successful! Please login.");
  show("managerLogin");
}

async function login(){
  const email = lEmail.value;
  const pass = lPass.value;
  const name = lName.value;
  
  if(!email || !pass || !name){
    alert("Please fill all fields");
    return;
  }
  
  // Try to get from Google Sheets first
  const result = await sendToSheets('getManager', {email: email});
  
  if(result.status === 'found' && result.pass === pass) {
    currentManagerEmail = email;
    currentManagerName = name;
    
    // Load restaurant data
    const restData = await sendToSheets('getRestaurant', {email: email});
    if(restData.status === 'found') {
      restName.value = restData.name;
      tables.value = restData.tables;
      currentRestaurantCode = restData.code;
      
      // Load menu and waiters
      await loadMenu();
      await loadWaiters();
    }
    
    show("managerDash");
  } else {
    alert("Invalid credentials");
  }
}

async function setupRestaurant(){
  if(!restName.value || !tables.value){
    alert("Please enter restaurant name and number of tables");
    return;
  }
  
  const code = currentRestaurantCode || "R"+Math.floor(Math.random()*9999);
  currentRestaurantCode = code;
  
  // Save to Google Sheets
  await sendToSheets('saveRestaurant', {
    name: restName.value,
    tables: tables.value,
    code: code,
    email: currentManagerEmail
  });
  
  // Also save to localStorage as backup
  localStorage.setItem("restaurant",JSON.stringify({
    name: restName.value,
    tables: tables.value,
    code: code,
    menu: [],
    waiters: []
  }));
  
  alert("Restaurant saved! Code: "+code);
}

async function addWaiter(){
  const waiterNameValue = document.getElementById('waiterName').value;
  
  if(!waiterNameValue){
    alert("Please enter waiter name");
    return;
  }
  
  // Save to Google Sheets
  await sendToSheets('saveWaiter', {
    code: currentRestaurantCode,
    waiterName: waiterNameValue
  });
  
  // Also update localStorage
  let r = JSON.parse(localStorage.getItem("restaurant")) || {waiters: []};
  if(!r.waiters) r.waiters = [];
  r.waiters.push({name: waiterNameValue});
  localStorage.setItem("restaurant", JSON.stringify(r));
  
  await loadWaiters();
  
  // Clear input
  document.getElementById('waiterName').value = '';
}

async function loadWaiters(){
  const result = await sendToSheets('getWaiters', {code: currentRestaurantCode});
  
  if(result.status === 'success') {
    // Update localStorage
    let r = JSON.parse(localStorage.getItem("restaurant")) || {};
    r.waiters = result.waiters;
    localStorage.setItem("restaurant", JSON.stringify(r));
    
    // Render waiters
    renderWaiters();
  }
}

function renderWaiters(){
  let r = JSON.parse(localStorage.getItem("restaurant"));
  if(!r || !r.waiters) return;
  waiterList.innerHTML = "";
  r.waiters.forEach((w, i) => {
    waiterList.innerHTML += `
    <p>${w.name}
    <button onclick="deleteWaiter(${i})">Delete</button></p>`;
  });
}

async function deleteWaiter(i){
  let r = JSON.parse(localStorage.getItem("restaurant"));
  const waiterNameValue = r.waiters[i].name;
  
  // Delete from Google Sheets
  await sendToSheets('deleteWaiter', {
    code: currentRestaurantCode,
    waiterName: waiterNameValue
  });
  
  // Delete from localStorage
  r.waiters.splice(i, 1);
  localStorage.setItem("restaurant", JSON.stringify(r));
  
  renderWaiters();
}

async function addMenu(){
  const itemName = document.getElementById('itemName').value;
  const itemPrice = Number(document.getElementById('itemPrice').value);
  
  if(!itemName || !itemPrice){
    alert("Please enter item name and price");
    return;
  }
  
  // Save to Google Sheets
  await sendToSheets('saveMenu', {
    code: currentRestaurantCode,
    itemName: itemName,
    itemPrice: itemPrice
  });
  
  // Also update localStorage
  let r = JSON.parse(localStorage.getItem("restaurant")) || {menu: []};
  r.menu.push({name: itemName, price: itemPrice});
  localStorage.setItem("restaurant", JSON.stringify(r));
  
  await loadMenu();
  
  // Clear inputs
  document.getElementById('itemName').value = '';
  document.getElementById('itemPrice').value = '';
}

async function loadMenu(){
  const result = await sendToSheets('getMenu', {code: currentRestaurantCode});
  
  if(result.status === 'success') {
    // Update localStorage
    let r = JSON.parse(localStorage.getItem("restaurant")) || {};
    r.menu = result.menu;
    localStorage.setItem("restaurant", JSON.stringify(r));
    
    // Render menu
    renderMenu();
  }
}

function renderMenu(){
let r=JSON.parse(localStorage.getItem("restaurant"));
if(!r || !r.menu) return;
menuList.innerHTML="";
r.menu.forEach((m,i)=>{
menuList.innerHTML+=`
<p>${m.name} - ₹${m.price}
<button onclick="deleteMenu(${i})">Delete</button></p>`;
});
}

async function deleteMenu(i){
  let r = JSON.parse(localStorage.getItem("restaurant"));
  const itemName = r.menu[i].name;
  
  // Delete from Google Sheets
  await sendToSheets('deleteMenu', {
    code: currentRestaurantCode,
    itemName: itemName
  });
  
  // Delete from localStorage
  r.menu.splice(i,1);
  localStorage.setItem("restaurant",JSON.stringify(r));
  
  renderMenu();
}

async function waiterEnter(){
  const code = codeInput.value;
  
  if(!code){
    alert("Please enter restaurant code");
    return;
  }
  
  // Check Google Sheets
  const result = await sendToSheets('getRestaurant', {code: code});
  
  if(result.status !== 'found') {
    return alert("Invalid Code");
  }
  
  currentRestaurantCode = code;
  
  // Load restaurant data
  localStorage.setItem("restaurant", JSON.stringify({
    name: result.name,
    tables: result.tables,
    code: code,
    menu: [],
    waiters: []
  }));
  
  // Load menu
  await loadMenu();
  
  show("tablesScreen");
  tableButtons.innerHTML="";
  for(let i=1; i<=result.tables; i++){
    tableButtons.innerHTML+=`
    <button class="btn white" onclick="openTable(${i})">
      Table ${i}
    </button>`;
  }
}

let currentTable;
let order=[];
let splitData=[];

function openTable(t){
currentTable=t;
order=[];
splitData=[];
show("orderScreen");
}

function continueBilling(){
billingArea.innerHTML="";
menuArea.innerHTML="";
let type=groupType.value;

if(type==="Family"){
buildSingleMenu();
}else{
billingArea.innerHTML=`
<label>Number of People</label>
<input id="numPeople" type="number" placeholder="Enter number">
<button class="btn primary" onclick="setupSplit()">Continue</button>
`;
}
}

function setupSplit(){
let n=numPeople.value;

if(!n || n<1){
  alert("Please enter valid number of people");
  return;
}

billingArea.innerHTML="";

for(let i=0;i<n;i++){
billingArea.innerHTML+=`
<label>Person ${i+1} Name</label>
<input class="personName" type="text" placeholder="Person ${i+1}">
`;
}

billingArea.innerHTML+=`
<button class="btn primary" onclick="buildSplitMenu()">Continue to Menu</button>
`;
}

function buildSingleMenu(){
let r=JSON.parse(localStorage.getItem("restaurant"));
menuArea.innerHTML="<h4>Select Items</h4>";

r.menu.forEach(m=>{
menuArea.innerHTML+=`
<button class="btn white"
onclick="addItem('${m.name}',${m.price})">
${m.name} - ₹${m.price}
</button>`;
});

menuArea.innerHTML+=`
<button class="btn primary" onclick="finalBill()">Generate Bill</button>
`;
}

function buildSplitMenu(){
let names=[...document.querySelectorAll(".personName")].map(x=>x.value);

if(names.some(n=>!n)){
  alert("Please enter all names");
  return;
}

splitData=names.map(n=>({name:n,total:0}));

let r=JSON.parse(localStorage.getItem("restaurant"));
menuArea.innerHTML=`
<label>Select Person</label>
<select id="personSelect">
${names.map(n=>`<option>${n}</option>`).join('')}
</select>
<h4>Select Items</h4>
`;

r.menu.forEach(m=>{
menuArea.innerHTML+=`
<button class="btn white"
onclick="addSplitItem('${m.name}',${m.price})">
${m.name} - ₹${m.price}
</button>`;
});

menuArea.innerHTML+=`
<button class="btn primary" onclick="finalBill()">Generate Bill</button>
`;
}

function addItem(n,p){
order.push({item:n,price:p});
alert("Added: "+n);
}

function addSplitItem(n,p){
let person=personSelect.value;
order.push({person,item:n,price:p});
let obj=splitData.find(x=>x.name===person);
obj.total+=p;
alert("Added "+n+" for "+person);
}

async function finalBill(){
  show("billScreen");

  let html="<strong>Table "+currentTable+"</strong><hr>";
  let total=0;

  order.forEach(o=>{
    html+=o.item+" - ₹"+o.price+"<br>";
    total+=o.price;
  });

  html+="<hr><strong>Total: ₹"+total+"</strong>";

  if(splitData.length){
    html+="<hr><strong>Split Bills:</strong><br>";
    splitData.forEach(s=>{
      html+=s.name+" pays ₹"+s.total+"<br>";
    });
  }

  billOutput.innerHTML=html;
  
  // Save order to Google Sheets
  await sendToSheets('saveOrder', {
    code: currentRestaurantCode,
    table: currentTable,
    groupType: groupType.value,
    order: order,
    total: total,
    splitData: splitData
  });
}

function printBill(){
window.print();
}

</script>

</body>
</html>
